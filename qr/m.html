<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QR Scanner</title>
    
    <!-- PWA манифест -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUVIgU2Nhbm5lciIsInNob3J0X25hbWUiOiJRUlNjYW4iLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6ImZ1bGxzY3JlZW4iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiIzAwN2ZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdkbWxsZDBKdmVEMGlNQ0F3SURVNU5pQTBPVFlpSUdacGJHdzlJaU13TURkbVptWWlQanh5WldOMElIZzlJakUySWlCNVBTSXhOaUlnZDJsa2RHZzlJalEyTkNJZ2FHVnBaMmgwUFNJME5qUWlJSEo0UFNJeU5DSWdabWxzYkQwaVlXeHBZMlZpYkhWbElqNDhMM0psWTNRK1BIQmhkR2dnWkQwaVRUSXdNaUF5TXpGTWVXNXNSVXRZTWpGamQwZzBjV0ZITFZZMU5saDVWbTVJVmxFelFWRkpjM0J6TmpCaGVXWjRhVGw1SWlCbWFXeHNQU0pqZFhKeVpXNTBRMjlzYjNJaUx6NDhMM04yWno0PSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- iOS Safari настройки -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QR Scanner">
    
    <!-- QR Scanner библиотека -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }
        
        #scanner-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        #scanner-frame {
            width: 280px;
            height: 280px;
            border: 3px solid #007fff;
            border-radius: 16px;
            position: relative;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        
        #scanner-frame::before,
        #scanner-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #007fff;
        }
        
        #scanner-frame::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 16px;
        }
        
        #scanner-frame::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 16px;
        }
        
        #result-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        #result-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 16px;
            margin: 20px;
            max-width: 90%;
            text-align: center;
        }
        
        #result-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        #close-result {
            background: #007fff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #copy-result {
            background: #333;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #status {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Анимация сканирования */
        @keyframes scan {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(280px);
            }
        }
        
        #scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #007fff, transparent);
            animation: scan 2s infinite;
        }
        
        /* Адаптивность */
        @media (max-width: 480px) {
            #scanner-frame {
                width: 250px;
                height: 250px;
            }
            
            #result-content {
                padding: 20px;
            }
            
            #status {
                top: 40px;
                font-size: 12px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div id="scanner-container">
        <video id="qr-video" playsinline></video>
        
        <div id="scanner-overlay">
            <div id="scanner-frame">
                <div id="scanner-line"></div>
            </div>
        </div>
        
        <div id="status">Загрузка камеры...</div>
    </div>
    
    <div id="result-overlay">
        <div id="result-content">
            <div id="result-text"></div>
            <button id="close-result">Продолжить сканирование</button>
            <button id="copy-result">Копировать</button>
        </div>
    </div>

    <script>
        class QRScannerApp {
            constructor() {
                this.scanner = null;
                this.videoElement = document.getElementById('qr-video');
                this.statusElement = document.getElementById('status');
                this.resultOverlay = document.getElementById('result-overlay');
                this.resultText = document.getElementById('result-text');
                this.closeButton = document.getElementById('close-result');
                this.copyButton = document.getElementById('copy-result');
                this.isScanning = false;
                
                this.init();
            }
            
            async init() {
                try {
                    // Проверяем поддержку камеры
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Камера не поддерживается');
                    }
                    
                    // Запрашиваем разрешение на камеру
                    await this.requestCameraPermission();
                    
                    // Инициализируем сканер
                    this.scanner = new QrScanner(
                        this.videoElement,
                        (result) => this.onScanSuccess(result),
                        {
                            onDecodeError: (error) => {
                                // Игнорируем ошибки декодирования - это нормально
                                console.debug('Decode error:', error);
                            },
                            highlightScanRegion: false,
                            highlightCodeOutline: false,
                            preferredCamera: 'environment', // Задняя камера
                            maxScansPerSecond: 3
                        }
                    );
                    
                    // Настраиваем обработчики событий
                    this.setupEventHandlers();
                    
                    // Запускаем сканирование
                    await this.startScanning();
                    
                } catch (error) {
                    console.error('Ошибка инициализации:', error);
                    this.showStatus('Ошибка доступа к камере: ' + error.message);
                }
            }
            
            async requestCameraPermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    // Останавливаем поток - он нужен был только для получения разрешения
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    throw new Error('Необходимо разрешить доступ к камере');
                }
            }
            
            setupEventHandlers() {
                this.closeButton.addEventListener('click', () => {
                    this.hideResult();
                    this.startScanning();
                });
                
                this.copyButton.addEventListener('click', () => {
                    this.copyToClipboard();
                });
                
                // Обработка ориентации устройства
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        if (this.scanner && this.isScanning) {
                            this.scanner.stop();
                            this.scanner.start();
                        }
                    }, 500);
                });
            }
            
            async startScanning() {
                try {
                    if (this.scanner) {
                        await this.scanner.start();
                        this.isScanning = true;
                        this.showStatus('Наведите камеру на QR-код');
                    }
                } catch (error) {
                    console.error('Ошибка запуска сканера:', error);
                    this.showStatus('Ошибка запуска камеры');
                }
            }
            
            onScanSuccess(result) {
                if (this.isScanning) {
                    this.isScanning = false;
                    this.scanner.stop();
                    
                    // Воспроизводим звук успеха (если доступно)
                    this.playSuccessSound();
                    
                    // Показываем результат
                    this.showResult(result.data);
                }
            }
            
            showResult(data) {
                this.resultText.textContent = data;
                this.resultOverlay.style.display = 'flex';
                this.hideStatus();
            }
            
            hideResult() {
                this.resultOverlay.style.display = 'none';
            }
            
            showStatus(message) {
                this.statusElement.textContent = message;
                this.statusElement.classList.remove('hidden');
            }
            
            hideStatus() {
                this.statusElement.classList.add('hidden');
            }
            
            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.resultText.textContent);
                    this.copyButton.textContent = 'Скопировано!';
                    setTimeout(() => {
                        this.copyButton.textContent = 'Копировать';
                    }, 2000);
                } catch (error) {
                    console.error('Ошибка копирования:', error);
                    // Fallback для старых браузеров
                    this.fallbackCopyToClipboard(this.resultText.textContent);
                }
            }
            
            fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.copyButton.textContent = 'Скопировано!';
                    setTimeout(() => {
                        this.copyButton.textContent = 'Копировать';
                    }, 2000);
                } catch (error) {
                    console.error('Ошибка копирования:', error);
                }
                document.body.removeChild(textArea);
            }
            
            playSuccessSound() {
                // Создаем короткий звуковой сигнал
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.debug('Звук недоступен:', error);
                }
            }
        }
        
        // Регистрируем Service Worker для PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'qr-scanner-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('SW registered:', registration);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
        
        // Запускаем приложение
        window.addEventListener('load', () => {
            new QRScannerApp();
        });
        
        // Предотвращаем случайное обновление страницы
        window.addEventListener('beforeunload', (event) => {
            event.preventDefault();
            event.returnValue = '';
        });
    </script>
</body>
</html>
