<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR –°–∫–∞–Ω–µ—Ä - –§–ì–ò–°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .scanner-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .scanner-area {
            text-align: center;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        
        .scan-button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }
        
        .scan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .result-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 20px;
            display: none;
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
        }
        
        .result-header h2 {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .data-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }
        
        .data-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .data-row {
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }
        
        .data-value {
            color: #333;
            word-wrap: break-word;
        }
        
        .url-link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }
        
        .url-link:hover {
            text-decoration: underline;
        }
        
        .raw-data {
            background: #f1f3f4;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            white-space: pre-wrap;
            border: 1px solid #ddd;
        }
        
        .toggle-raw {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .scanner-container, .result-container {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .scan-button {
                padding: 12px 24px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± QR –°–∫–∞–Ω–µ—Ä</h1>
            <p>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –§–ì–ò–°</p>
        </div>
        
        <div class="scanner-container">
            <div class="scanner-area">
                <video id="video" autoplay muted playsinline></video>
                <div id="scanner-placeholder">
                    <h3>–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞</p>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button id="startScan" class="scan-button">üîç –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                <button id="stopScan" class="scan-button" style="display: none;">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div id="result" class="result-container">
            <div class="result-header">
                <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                <p>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –§–ì–ò–°</p>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            
            <div id="data-content"></div>
            
            <button id="toggleRaw" class="toggle-raw" style="display: none;">–ü–æ–∫–∞–∑–∞—Ç—å JSON</button>
            <div id="rawData" class="raw-data" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.min.js"></script>
    <script>
        class QRCodeScanner {
            constructor() {
                this.scanner = null;
                this.isScanning = false;
                this.initializeElements();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.video = document.getElementById('video');
                this.startBtn = document.getElementById('startScan');
                this.stopBtn = document.getElementById('stopScan');
                this.status = document.getElementById('status');
                this.result = document.getElementById('result');
                this.loading = document.getElementById('loading');
                this.dataContent = document.getElementById('data-content');
                this.rawData = document.getElementById('rawData');
                this.toggleRaw = document.getElementById('toggleRaw');
                this.placeholder = document.getElementById('scanner-placeholder');
            }
            
            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.toggleRaw.addEventListener('click', () => this.toggleRawData());
            }
            
            showStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                this.status.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        this.status.style.display = 'none';
                    }, 3000);
                }
            }
            
            async startScanning() {
                try {
                    this.showStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...', 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera API not supported');
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    this.video.style.display = 'block';
                    this.placeholder.style.display = 'none';
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è QR —Å–∫–∞–Ω–µ—Ä–∞
                    this.scanner = new QrScanner(this.video, 
                        (result) => this.onScanSuccess(result),
                        {
                            returnDetailedScanResult: true,
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                        }
                    );
                    
                    await this.scanner.start();
                    this.isScanning = true;
                    
                    this.startBtn.style.display = 'none';
                    this.stopBtn.style.display = 'inline-block';
                    this.showStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ. –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥', 'success');
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:', error);
                    this.showStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
                }
            }
            
            stopScanning() {
                if (this.scanner) {
                    this.scanner.stop();
                    this.scanner.destroy();
                    this.scanner = null;
                }
                
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                }
                
                this.video.style.display = 'none';
                this.placeholder.style.display = 'block';
                this.isScanning = false;
                
                this.startBtn.style.display = 'inline-block';
                this.stopBtn.style.display = 'none';
                this.showStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
            }
            
            async onScanSuccess(result) {
                const qrData = result.data;
                console.log('QR Code –Ω–∞–π–¥–µ–Ω:', qrData);
                
                this.showStatus('QR-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω! –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'success');
                this.stopScanning();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL
                const urlPattern = /https:\/\/fgis\.gost\.ru\/fundmetrology\/cm\/results\/(.+)/;
                const match = qrData.match(urlPattern);
                
                if (match) {
                    const id = match[1];
                    const apiUrl = `https://fgis.gost.ru/fundmetrology/cm/iaux/vri/${id}`;
                    await this.fetchData(apiUrl, qrData);
                } else {
                    this.showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è URL –≤–∏–¥–∞: https://fgis.gost.ru/fundmetrology/cm/results/...', 'error');
                }
            }
            
            async fetchData(apiUrl, originalUrl) {
                try {
                    this.result.style.display = 'block';
                    this.loading.style.display = 'block';
                    this.dataContent.innerHTML = '';
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    this.loading.style.display = 'none';
                    this.displayData(data, originalUrl, apiUrl);
                    this.showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã!', 'success');
                    
                } catch (error) {
                    this.loading.style.display = 'none';
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                    this.showStatus(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                }
            }
            
            displayData(data, originalUrl, apiUrl) {
                let html = `
                    <div class="data-section">
                        <h3>üîó URL Information</h3>
                        <div class="data-row">
                            <div class="data-label">–ò—Å—Ö–æ–¥–Ω—ã–π URL (QR):</div>
                            <div class="data-value"><a href="${originalUrl}" target="_blank" class="url-link">${originalUrl}</a></div>
                        </div>
                        <div class="data-row">
                            <div class="data-label">API URL:</div>
                            <div class="data-value"><a href="${apiUrl}" target="_blank" class="url-link">${apiUrl}</a></div>
                        </div>
                    </div>
                `;
                
                if (data.result && data.result.miInfo && data.result.miInfo.singleMI) {
                    const mi = data.result.miInfo.singleMI;
                    html += `
                        <div class="data-section">
                            <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–¥—Å—Ç–≤–µ –∏–∑–º–µ—Ä–µ–Ω–∏–π</h3>
                            <div class="data-row">
                                <div class="data-label">–ù–æ–º–µ—Ä —Ç–∏–ø–∞:</div>
                                <div class="data-value">${mi.mitypeNumber || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–¢–∏–ø:</div>
                                <div class="data-value">${mi.mitypeType || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</div>
                                <div class="data-value">${mi.mitypeTitle || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä:</div>
                                <div class="data-value">${mi.manufactureNum || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:</div>
                                <div class="data-value">${mi.modification || 'N/A'}</div>
                            </div>
                            ${mi.mitypeURL ? `
                            <div class="data-row">
                                <div class="data-label">URL —Ç–∏–ø–∞:</div>
                                <div class="data-value"><a href="${mi.mitypeURL}" target="_blank" class="url-link">${mi.mitypeURL}</a></div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                if (data.result && data.result.vriInfo) {
                    const vri = data.result.vriInfo;
                    html += `
                        <div class="data-section">
                            <h3>‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–≤–µ—Ä–∫–µ</h3>
                            <div class="data-row">
                                <div class="data-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</div>
                                <div class="data-value">${vri.organization || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–ó–Ω–∞–∫ –ø–æ–≤–µ—Ä–∫–∏:</div>
                                <div class="data-value">${vri.signCipher || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–í–ª–∞–¥–µ–ª–µ—Ü –°–ò:</div>
                                <div class="data-value">${vri.miOwner || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–î–∞—Ç–∞ –ø–æ–≤–µ—Ä–∫–∏:</div>
                                <div class="data-value">${vri.vrfDate || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –¥–æ:</div>
                                <div class="data-value">${vri.validDate || 'N/A'}</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">–î–æ–∫—É–º–µ–Ω—Ç:</div>
                                <div class="data-value">${vri.docTitle || 'N/A'}</div>
                            </div>
                            ${vri.applicable ? `
                            <div class="data-row">
                                <div class="data-label">–ù–æ–º–µ—Ä —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞:</div>
                                <div class="data-value">${vri.applicable.certNum || 'N/A'}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                if (data.result && data.result.means && data.result.means.mieta) {
                    html += `
                        <div class="data-section">
                            <h3>üîß –≠—Ç–∞–ª–æ–Ω—ã</h3>
                    `;
                    
                    data.result.means.mieta.forEach((mieta, index) => {
                        html += `
                            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <h4>–≠—Ç–∞–ª–æ–Ω ${index + 1}</h4>
                                <div class="data-row">
                                    <div class="data-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä:</div>
                                    <div class="data-value">${mieta.regNumber || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</div>
                                    <div class="data-value">${mieta.mitypeTitle || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ:</div>
                                    <div class="data-value">${mieta.notation || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:</div>
                                    <div class="data-value">${mieta.modification || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä:</div>
                                    <div class="data-value">${mieta.manufactureNum || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</div>
                                    <div class="data-value">${mieta.manufactureYear || 'N/A'}</div>
                                </div>
                                <div class="data-row">
                                    <div class="data-label">–†–∞–∑—Ä—è–¥:</div>
                                    <div class="data-value">${mieta.rankTitle || 'N/A'} (${mieta.rankCode || 'N/A'})</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                if (data.result && data.result.info) {
                    const info = data.result.info;
                    html += `
                        <div class="data-section">
                            <h3>‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            ${info.additional_info ? `
                            <div class="data-row">
                                <div class="data-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</div>
                                <div class="data-value">${info.additional_info}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                this.dataContent.innerHTML = html;
                this.rawData.textContent = JSON.stringify(data, null, 2);
                this.toggleRaw.style.display = 'inline-block';
            }
            
            toggleRawData() {
                const isVisible = this.rawData.style.display === 'block';
                this.rawData.style.display = isVisible ? 'none' : 'block';
                this.toggleRaw.textContent = isVisible ? '–ü–æ–∫–∞–∑–∞—Ç—å JSON' : '–°–∫—Ä—ã—Ç—å JSON';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            new QRCodeScanner();
        });
    </script>
</body>
</html>
