<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>QR —Å–∫–∞–Ω–µ—Ä –ø–æ–≤–µ—Ä–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f9f9f9;
    }
    video {
      width: 100%;
      max-height: 300px;
      border: 1px solid #ccc;
      margin-top: 1rem;
    }
    #result {
      margin-top: 1rem;
      background: #e0ffe0;
      padding: 1rem;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h1>üì∑ –°–∫–∞–Ω–µ—Ä –ø–æ–≤–µ—Ä–∫–∏</h1>
<p>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥...</p>
<video id="video" playsinline></video>
<div id="result">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>

<script type="module">
  import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

  const videoElem = document.getElementById("video");
  const resultElem = document.getElementById("result");

  const scanner = new QrScanner(videoElem, result => {
    handleQRCode(result);
  }, {
    preferredCamera: 'environment',
    highlightScanRegion: true,
    highlightCodeOutline: true
  });

  async function startScanner() {
    try {
      await QrScanner.hasCamera();
      await scanner.start();
    } catch (e) {
      resultElem.innerText = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: " + e.message;
    }
  }

  async function handleQRCode(text) {
    scanner.stop();
    resultElem.innerText = `üîó QR: ${text}`;

    const match = text.match(/results\/(.+)$/);
    if (!match) {
      resultElem.innerText += `\n‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞`;
      return;
    }

    const id = match[1];
    const apiUrl = `https://fgis.gost.ru/fundmetrology/cm/iaux/vri/${id}`;

    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ API: " + response.status);
      const data = await response.json();

      const manufactureNum = data?.result?.miInfo?.singleMI?.manufactureNum;

      resultElem.innerText += `\nüè∑Ô∏è –ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä: ${manufactureNum ?? "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"}`;
    } catch (e) {
      resultElem.innerText += `\n‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${e.message}`;
    }
  }

  startScanner();
</script>

</body>
</html>
